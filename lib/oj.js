// Generated by CoffeeScript 1.3.3
(function() {
  var ArrayP, F, FuncP, ObjP, coffee, exports, fs, isCS, isJS, jqueryEvents, oj, pass, root, slice, stripBOM, t, unshift, wrapCSMessage, wrapJS, wrapJSMessage, _, _attributeCMeansClass, _attributeClassAllowsArrays, _attributeStyleAllowsObject, _attributesFilterOutEvents, _attributesFromObject, _chars, _compileAny, _compileDeeper, _compileTag, _cssFromObject, _defaultClear, _fn, _i, _len, _randomInteger, _readyOrLoad, _readyQueue, _ref, _styleFromObject, _styleKeyFromFancy, _tagAttributes,
    __slice = [].slice;

  oj = module.exports = function(ojml) {
    return oj.tag('oj', ojml);
  };

  oj.oj = oj;

  oj.begin = function(page) {
    return _readyOrLoad(function() {
      var body, bodyOnly, d, dom, _i, _len;
      bodyOnly = {
        html: 1,
        doctype: 1,
        head: 1,
        link: 1,
        script: 1
      };
      dom = oj.compile({
        dom: 1,
        html: 0,
        css: 0,
        ignore: bodyOnly
      }, require(page)).dom;
      if (!(dom != null)) {
        console.error('oj: dom failed to compile');
        return;
      }
      body = document.getElementsByTagName('body');
      if (body.length === 0) {
        console.error('oj: <body> was not found');
        return;
      }
      body = body[0];
      body.innerHTML = '';
      if (!oj.isArray(dom)) {
        dom = [dom];
      }
      for (_i = 0, _len = dom.length; _i < _len; _i++) {
        d = dom[_i];
        body.appendChild(d);
      }
      return oj.ready();
    });
  };

  _readyOrLoad = function(fn) {
    var prevOnLoad;
    if (typeof $ !== "undefined" && $ !== null) {
      $(fn);
    } else {
      if (document.readyState !== "complete") {
        prevOnLoad = window.onload;
        window.onload = function() {
          if (typeof prevOnLoad === "function") {
            prevOnLoad();
          }
          return fn();
        };
      } else {
        fn();
      }
    }
  };

  oj.error = function(message) {
    var red, reset, _ref, _ref1, _ref2, _ref3;
    red = (_ref = (_ref1 = oj.codes) != null ? _ref1.red : void 0) != null ? _ref : '';
    reset = (_ref2 = (_ref3 = oj.codes) != null ? _ref3.red : void 0) != null ? _ref2 : '';
    console.error("" + red + message + reset);
  };

  _readyQueue = {
    queue: [],
    loaded: false
  };

  oj.ready = function(fn) {
    var f;
    if (oj.isUndefined(fn)) {
      _readyQueue.loaded = true;
      while ((f = _readyQueue.queue.shift())) {
        f();
      }
    } else if (_readyQueue.loaded) {
      f();
    } else {
      _readyQueue.queue.push(fn);
    }
  };

  oj.id = function(len, chars) {
    return 'oj' + oj.guid(len, chars);
  };

  _randomInteger = function(min, max) {
    var diff, rnd;
    if (min === null || max === null || min > max) {
      return null;
    }
    diff = max - min;
    rnd = Math.floor(Math.random() * (diff + 1));
    return rnd + min;
  };

  _chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split('');

  oj.guid = function(len, chars) {
    var base, charNext, charsPerRand, i, output, rand, randMax, randMin, _i;
    if (len == null) {
      len = 8;
    }
    if (chars == null) {
      chars = _chars;
    }
    base = chars.length;
    charsPerRand = Math.floor(Math.log(Math.pow(2, 31) - 1) / Math.log(base));
    randMin = 0;
    randMax = Math.pow(base, charsPerRand) - 1;
    output = "";
    for (i = _i = 0; 0 <= len ? _i < len : _i > len; i = 0 <= len ? ++_i : --_i) {
      if (i % charsPerRand === 0) {
        rand = _randomInteger(randMin, randMax);
      }
      charNext = chars[rand % base];
      output += charNext;
      rand = Math.floor(rand / base);
    }
    return output;
  };

  if (require.extensions) {
    coffee = require('coffee-script');
    fs = require(new String('fs'));
    stripBOM = function(c) {
      if (c.charCodeAt(0) === 0xFEFF) {
        return c.slice(1);
      } else {
        return c;
      }
    };
    isCS = function(code) {
      return -1 !== code.search(/(^\s*#|\n\s*#|-\>)/);
    };
    isJS = function(code) {
      return -1 !== code.search(/var|function|((^|\n)\s*\/\/)/);
    };
    wrapJS = function(code) {
      return "(function(){with(require('oj')){" + code + "}}).call(this);";
    };
    wrapCSMessage = function(message, filepath) {
      var _ref, _ref1;
      return "" + ((_ref = oj.codes) != null ? _ref.red : void 0) + "coffee-script error in " + filepath + ": " + message + ((_ref1 = oj.codes) != null ? _ref1.reset : void 0);
    };
    wrapJSMessage = function(message, filepath) {
      var _ref, _ref1;
      return "" + ((_ref = oj.codes) != null ? _ref.red : void 0) + "javascript error in " + filepath + ": " + message + ((_ref1 = oj.codes) != null ? _ref1.reset : void 0);
    };
    require.extensions['.oj'] = function(module, filepath) {
      var code;
      code = stripBOM(fs.readFileSync(filepath, 'utf8'));
      try {
        code = wrapJS(code);
        return module._compile(code, filepath);
      } catch (eJS) {
        eJS.message = wrapJSMessage(eJS.message, filepath);
        throw eJS;
      }
    };
    require.extensions['.ojc'] = function(module, filepath) {
      var code;
      code = stripBOM(fs.readFileSync(filepath, 'utf8'));
      try {
        code = coffee.compile(code, {
          bare: true
        });
      } catch (eCoffee) {
        eCoffee.message = wrapCSMessage(eCoffee.message, filepath);
        throw eCoffee;
      }
      try {
        code = wrapJS(code);
        return module._compile(code, filepath);
      } catch (eJS) {
        eJS.message = wrapJSMessage(eJS.message, filepath);
        throw eJS;
      }
    };
  }

  root = this;

  oj.version = '0.0.7';

  oj.isClient = true;

  if (typeof module !== 'undefined') {
    exports = module.exports = oj;
  } else {
    root['oj'] = oj;
  }

  oj.isUndefined = function(obj) {
    return obj === void 0;
  };

  oj.isBoolean = function(obj) {
    return obj === true || obj === false || toString.call(obj) === '[object Boolean]';
  };

  oj.isNumber = function(obj) {
    return !!(obj === 0 || (obj && obj.toExponential && obj.toFixed));
  };

  oj.isString = function(obj) {
    return !!(obj === '' || (obj && obj.charCodeAt && obj.substr));
  };

  oj.isDate = function(obj) {
    return !!(obj && obj.getTimezoneOffset && obj.setUTCFullYear);
  };

  oj.isFunction = function(obj) {
    return typeof obj === 'function';
  };

  oj.isArray = Array.isArray || function(obj) {
    return toString.call(obj) === '[object Array]';
  };

  oj.isRegEx = function(obj) {
    return toString.call(obj) === '[object RegExp]';
  };

  oj.isDOM = function(obj) {
    return !!(obj && (obj.nodeType != null));
  };

  oj.isDOMElement = function(obj) {
    return !!(obj && obj.nodeType === 1);
  };

  oj.isDOMAttribute = function(obj) {
    return !!(obj && obj.nodeType === 2);
  };

  oj.isDOMText = function(obj) {
    return !!(obj && obj.nodeType === 3);
  };

  oj.isjQuery = function(obj) {
    return !!(obj && obj.jquery);
  };

  oj.isBackbone = function(obj) {
    return !!(obj && obj.on && obj.off && obj.trigger);
  };

  oj.isOJ = function(obj) {
    return !!(obj != null ? obj.isOJ : void 0);
  };

  oj.isArguments = function(obj) {
    return toString.call(obj) === '[object Arguments]';
  };

  ArrayP = Array.prototype;

  FuncP = Function.prototype;

  ObjP = Object.prototype;

  slice = ArrayP.slice;

  unshift = ArrayP.unshift;

  oj.__ = _ = {};

  _.isCapitalLetter = function(c) {
    return !!(c.match(/[A-Z]/));
  };

  _.identity = function(v) {
    return v;
  };

  _.property = function(obj, options) {
    if (options == null) {
      options = {};
    }
    return Object.defineProperty(obj, options);
  };

  _.has = function(obj, key) {
    return Object.prototype.hasOwnProperty.call(obj, key);
  };

  _.keys = Object.keys || function(obj) {
    var key, keys;
    if (obj !== Object(obj)) {
      throw 'Invalid object';
    }
    keys = [];
    for (key in obj) {
      if (_has(obj, key)) {
        keys[keys.length] = key;
      }
    }
    return keys;
  };

  _.values = function(obj) {
    var out;
    if (obj !== Object(obj)) {
      throw 'Invalid object';
    }
    out = [];
    _.each(obj, function(v) {
      return out.push(v);
    });
    return out;
  };

  _.flatten = function(array, shallow) {
    return _.reduce(array, (function(memo, value) {
      if (oj.isArray(value)) {
        return memo.concat(shallow ? value : _.flatten(value));
      }
      memo[memo.length] = value;
      return memo;
    }), []);
  };

  _.reduce = function(obj, iterator, memo, context) {
    var ctor, initial;
    if (obj == null) {
      obj = [];
    }
    initial = arguments.length > 2;
    if (ArrayP.reduce && obj.reduce === ArrayP.reduce) {
      if (context) {
        iterator = _.bind(iterator, context);
      }
      if (initial) {
        return obj.reduce(iterator, memo);
      } else {
        return obj.reduce(iterator);
      }
    }
    _.each(obj, function(value, index, list) {
      if (!initial) {
        memo = value;
        return initial = true;
      } else {
        return memo = iterator.call(context, memo, value, index, list);
      }
    });
    if (!initial) {
      throw new TypeError('Reduce of empty array with no initial value');
    }
    memo;

    ctor = function() {};
    return _.bind = function(func, context) {
      var args, bound;
      if (func.bind === FuncP.bind && FuncP.bind) {
        return FuncP.bind.apply(func, slice.call(arguments, 1));
      }
      if (!oj.isFunction(func)) {
        throw new TypeError;
      }
      args = slice.call(arguments, 2);
      return bound = function() {
        var result, self;
        if (!(this instanceof bound)) {
          return func.apply(context, args.concat(slice.call(arguments)));
        }
        ctor.prototype = func.prototype;
        self = new ctor;
        result = func.apply(self, args.concat(slice.call(arguments)));
        if (Object(result) === result) {
          return result;
        }
        return self;
      };
    };
  };

  _.sortedIndex = function(array, obj, iterator) {
    var high, low, mid;
    if (iterator == null) {
      iterator = _.identity;
    }
    low = 0;
    high = array.length;
    while (low < high) {
      mid = (low + high) >> 1;
      if (iterator(array[mid]) < iterator(obj)) {
        low = mid + 1;
      } else {
        high = mid;
      }
    }
    return low;
  };

  _.indexOf = function(array, item, isSorted) {
    var i, v, _i, _len;
    if (array == null) {
      return -1;
    }
    if (isSorted) {
      i = _.sortedIndex(array, item);
      if (array[i] === item) {
        return i;
      } else {
        return -1;
      }
    }
    if (ArrayP.indexOf && array.indexOf === ArrayP.indexOf) {
      return array.indexOf(item);
    }
    for (i = _i = 0, _len = array.length; _i < _len; i = ++_i) {
      v = array[i];
      if (v === item) {
        return i;
      }
    }
    return -1;
  };

  _.toArray = function(obj) {
    if (!obj) {
      return [];
    }
    if (oj.isArray(obj)) {
      return slice.call(obj);
    }
    if (oj.isArguments(obj)) {
      return slice.call(obj);
    }
    if (obj.toArray && oj.isFunction(obj.toArray)) {
      return obj.toArray();
    }
    return _.values(obj);
  };

  F = function() {};

  _.create = typeof Object.create === "function" ? Object.create : function(o) {
    var child;
    F.prototype = o;
    child = new F();
    F.prototype = null;
    return child;
  };

  _.getPrototypeOf = typeof Object.getPrototypeOf === "function" ? Object.getPrototypeOf : function(o) {
    return o.proto || o.constructor.prototype;
  };

  _.isEmpty = function(obj) {
    var k;
    if (oj.isArray(obj)) {
      return obj.length === 0;
    }
    for (k in obj) {
      if (_.has(obj, k)) {
        return false;
      }
    }
    return true;
  };

  oj.typeOf = function(any) {
    var t;
    if (any === null) {
      return 'null';
    }
    t = typeof any;
    if (t === 'object') {
      if (oj.isArray(any)) {
        t = 'array';
      } else if (oj.isOJ(any)) {
        t = any.type;
      } else if (oj.isRegEx(any)) {
        t = 'regexp';
      } else if (oj.isDate(any)) {
        t = 'date';
      } else if (oj.isDOMElement(any)) {
        t = 'element';
      } else if (oj.isDOMText(any)) {
        t = 'text';
      } else if (oj.isDOMAttribute(any)) {
        t = 'attribute';
      } else if (oj.isBackbone(any)) {
        t = 'backbone';
      } else if (oj.isjQuery(any)) {
        t = 'jquery';
      } else {
        t = 'object';
      }
    }
    return t;
  };

  oj.isObject = function(obj) {
    return (oj.typeOf(obj)) === 'object';
  };

  _.clone = function(obj) {
    if (!oj.isObject(obj)) {
      return obj;
    }
    if (oj.isArray(obj)) {
      return obj.slice();
    } else {
      return _.extend({}, obj);
    }
  };

  oj["enum"] = function(name, args) {
    throw 'NYI';
  };

  _.breaker = {};

  _.each = function(col, iterator, context) {
    var i, k, v, _i, _len;
    if (col === null) {
      return;
    }
    if (ArrayP.forEach && col.forEach === ArrayP.forEach) {
      return col.forEach(iterator, context);
    } else if (oj.isArray(col)) {
      for (i = _i = 0, _len = col.length; _i < _len; i = ++_i) {
        v = col[i];
        if (iterator.call(context, v, i, col) === _.breaker) {
          return _.breaker;
        }
      }
    } else {
      for (k in col) {
        v = col[k];
        if (_.has(col, k)) {
          if (iterator.call(context, v, k, col) === _.breaker) {
            return _.breaker;
          }
        }
      }
    }
  };

  _.map = function(obj, iterator, options) {
    var context, evaluate, iterator_, k, out, r, recurse, v;
    if (options == null) {
      options = {};
    }
    context = options.context;
    recurse = options.recurse;
    evaluate = options.evaluate;
    iterator_ = iterator;
    if (recurse) {
      (function(options) {
        return iterator_ = function(v, k, o) {
          var options_;
          options_ = _.extend(_.clone(options), {
            key: k,
            object: v
          });
          return _.map(v, iterator, options_);
        };
      })(options);
    }
    if (oj.isFunction(obj)) {
      if (!evaluate) {
        return obj;
      }
      while (evaluate && oj.isFunction(obj)) {
        obj = obj();
      }
    }
    out = obj;
    if (oj.isArray(obj)) {
      out = [];
      if (!obj) {
        return out;
      }
      if (ArrayP.map && obj.map === ArrayP.map) {
        return obj.map(iterator_, context);
      }
      _.each(obj, (function(v, ix, list) {
        return out[out.length] = iterator_.call(context, v, ix, list);
      }));
      if (obj.length === +obj.length) {
        out.length = obj.length;
      }
    } else if (oj.isObject(obj)) {
      out = {};
      if (!obj) {
        return out;
      }
      for (k in obj) {
        v = obj[k];
        if ((r = iterator_.call(context, v, k, obj)) !== void 0) {
          out[k] = r;
        }
      }
    } else {
      return iterator.call(context, obj, options.key, options.object);
    }
    return out;
  };

  _.extend = function(obj) {
    _.each(slice.call(arguments, 1), (function(source) {
      var key, value, _results;
      _results = [];
      for (key in source) {
        value = source[key];
        _results.push(obj[key] = value);
      }
      return _results;
    }));
    return obj;
  };

  _.defaults = function(obj) {
    _.each(slice.call(arguments, 1), (function(source) {
      var prop, _results;
      _results = [];
      for (prop in source) {
        if (!(obj[prop] != null)) {
          _results.push(obj[prop] = source[prop]);
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }));
    return obj;
  };

  _.uniqueSort = function(array, isSorted) {
    var item, ix, out, _i, _len;
    if (isSorted == null) {
      isSorted = false;
    }
    if (!isSorted) {
      array.sort();
    }
    out = [];
    for (ix = _i = 0, _len = array.length; _i < _len; ix = ++_i) {
      item = array[ix];
      if (ix > 0 && array[ix - 1] === array[ix]) {
        continue;
      }
      out.push(item);
    }
    return out;
  };

  _.uniqueSortedUnion = function(array, array2) {
    return _.uniqueSort(array.concat(array2));
  };

  oj.addMethods = function(obj, mapNameToMethod) {
    var method, methodName;
    for (methodName in mapNameToMethod) {
      method = mapNameToMethod[methodName];
      oj.addMethod(obj, methodName, method);
    }
  };

  oj.addMethod = function(obj, methodName, method) {
    if (!oj.isString(methodName)) {
      throw 'oj.addMethod: string expected for second argument';
    }
    if (!oj.isFunction(method)) {
      throw 'oj.addMethod: function expected for thrid argument';
    }
    Object.defineProperty(obj, methodName, {
      value: method,
      enumerable: false,
      writable: false,
      configurable: true
    });
  };

  oj.removeMethod = function(obj, methodName) {
    if (!oj.isString(methodName)) {
      throw 'oj.removeMethod: string expected for second argument';
    }
    delete obj[methodName];
  };

  oj.addProperties = function(obj, mapNameToInfo) {
    var propInfo, propName;
    for (propName in mapNameToInfo) {
      propInfo = mapNameToInfo[propName];
      if (!((propInfo != null ? propInfo.get : void 0) != null) && !((propInfo != null ? propInfo.value : void 0) != null)) {
        propInfo = {
          value: propInfo
        };
      }
      oj.addProperty(obj, propName, propInfo);
    }
  };

  oj.addProperty = function(obj, propName, propInfo) {
    if (!oj.isString(propName)) {
      throw 'oj.addProperty: string expected for second argument';
    }
    if (!(oj.isObject(propInfo))) {
      throw 'oj.addProperty: object expected for third argument';
    }
    if (!((propInfo.get != null) || (propInfo.value != null))) {
      throw 'oj.addProperty: get or value key expected in third argument';
    }
    _.defaults(propInfo, {
      enumerable: true,
      configurable: true
    });
    if (Object.getOwnPropertyDescriptor(obj, propName) != null) {
      oj.removeProperty(obj, propName);
    }
    Object.defineProperty(obj, propName, propInfo);
  };

  oj.removeProperty = function(obj, propName) {
    if (!oj.isString(propName)) {
      throw 'oj.addProperty: string expected for second argument';
    }
    return delete obj[propName];
  };

  oj.isProperty = function(obj, propName) {
    if (!oj.isString(propName)) {
      throw 'oj.isProperty: string expected for second argument';
    }
    return Object.getOwnPropertyDescriptor(obj, propName).get != null;
  };

  oj.copyProperty = function(dest, source, propName) {
    var info;
    info = Object.getOwnPropertyDescriptor(source, propName);
    return Object.defineProperty(dest, propName, info);
  };

  _.argumentsStack = [];

  oj.addProperty(_, 'arguments', {
    get: function() {
      if (_.argumentsStack.length) {
        return _.argumentsStack[_.argumentsStack.length - 1];
      } else {
        return null;
      }
    }
  });

  _.argumentsPush = function(args) {
    if (args == null) {
      args = [];
    }
    _.argumentsStack.push(args);
  };

  _.argumentsPop = function() {
    if (_.argumentsStack.length) {
      return _.argumentsStack.pop();
    }
    return null;
  };

  _.argumentsAppend = function(arg) {
    if (_["arguments"]) {
      _["arguments"].push(arg);
    }
  };

  oj.tag = function() {
    var arg, args, attributes, len, name, ojml, r, _i, _j, _len, _len1;
    name = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    if (!oj.isString(name)) {
      throw 'oj.tag error: argument 1 is not a string (expected tag name)';
    }
    ojml = [name];
    attributes = {};
    for (_i = 0, _len = args.length; _i < _len; _i++) {
      arg = args[_i];
      if (oj.isObject(arg)) {
        _.extend(attributes, arg);
      }
    }
    attributes = _tagAttributes(name, attributes);
    if (!_.isEmpty(attributes)) {
      ojml.push(attributes);
    }
    _.argumentsPush(ojml);
    for (_j = 0, _len1 = args.length; _j < _len1; _j++) {
      arg = args[_j];
      if (oj.isObject(arg)) {
        continue;
      } else if (oj.isFunction(arg)) {
        len = _["arguments"].length;
        r = arg();
        if (len === _["arguments"].length && (r != null)) {
          _.argumentsAppend(r);
        }
      } else {
        _.argumentsAppend(arg);
      }
    }
    _.argumentsPop();
    _.argumentsAppend(ojml);
    return ojml;
  };

  oj.tag.elements = {
    closed: 'a abbr acronym address applet article aside audio b bdo big blockquote body button canvas caption center cite code colgroup command datalist dd del details dfn dir div dl dt em embed fieldset figcaption figure font footer form frameset h1 h2 h3 h4 h5 h6 head header hgroup html i iframe ins keygen kbd label legend li map mark menu meter nav noframes noscript object ol optgroup option output p pre progress q rp rt ruby s samp script section select small source span strike strong style sub summary sup table tbody td textarea tfoot th thead time title tr tt u ul var video wbr xmp'.split(' '),
    open: 'area base br col command css embed hr img input keygen link meta param source track wbr'.split(' ')
  };

  oj.tag.elements.all = (oj.tag.elements.closed.concat(oj.tag.elements.open)).sort();

  oj.tag.isClosed = function(tag) {
    return (_.indexOf(oj.tag.elements.open, tag, true)) === -1;
  };

  _ref = oj.tag.elements.all;
  _fn = function(t) {
    oj[t] = function() {
      return oj.tag.apply(oj, [t].concat(__slice.call(arguments)));
    };
    return oj[t].type = t;
  };
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    t = _ref[_i];
    _fn(t);
  }

  _defaultClear = function(dest, d, e) {
    var k;
    _.defaults(dest, d);
    for (k in e) {
      delete dest[k];
    }
    return dest;
  };

  _tagAttributes = function(name, attributes) {
    var attr;
    attr = _.clone(attributes);
    switch (name) {
      case 'link':
        _defaultClear(attr, {
          rel: 'stylesheet',
          type: 'text/css',
          href: attr.url || attr.src
        }, {
          url: 0,
          src: 0
        });
        break;
      case 'script':
        _defaultClear(attr, {
          type: 'text/javascript',
          src: attr.url
        }, {
          url: 0
        });
        break;
      case 'a':
        _defaultClear(attr, {
          href: attr.url
        }, {
          url: 0
        });
    }
    return attr;
  };

  oj.page = function(options, content) {
    if (!(content != null)) {
      content = options;
      options = {};
    }
    return oj.html(function() {
      oj.head(function() {
        if (options.title != null) {
          return oj.title(options.title);
        }
      });
      return oj.body(function() {
        return content();
      });
    });
  };

  oj.extend = function(context) {
    var k, o, v;
    o = {};
    for (k in oj) {
      v = oj[k];
      if (k[0] !== '_') {
        o[k] = v;
      }
    }
    delete o.extend;
    return _.extend(context, o);
  };

  oj.compile = function(options, ojml) {
    var css, dom, html, out;
    if (!(ojml != null)) {
      ojml = options;
      options = {};
    }
    options = _.defaults({}, options, {
      html: true,
      dom: true,
      css: true,
      debug: false,
      ignore: {}
    });
    _.extend(options.ignore, {
      oj: 1,
      css: 1
    });
    options.html = options.html ? [] : null;
    options.dom = options.dom && (typeof document !== "undefined" && document !== null) ? document.createElement('OJ') : null;
    options.css = options.css ? {} : null;
    options.indent = '';
    options.types = [];
    options.tags = {};
    _compileAny(ojml, options);
    if (options.css) {
      css = _cssFromObject(options.css, options.debug);
    }
    if (options.html != null) {
      html = options.html.join('');
    }
    if (options.dom != null) {
      dom = options.dom.childNodes;
      if (dom.length != null) {
        dom = _.toArray(dom);
        dom = dom.filter(function(v) {
          return oj.isDOM(v);
        });
      }
      if (dom.length === 0) {
        dom = null;
      } else if (dom.length === 1) {
        dom = dom[0];
      }
    }
    out = {
      html: html,
      dom: dom,
      css: css,
      types: options.types,
      tags: options.tags
    };
    return out;
  };

  _styleKeyFromFancy = function(key) {
    var c, out, _j, _len1;
    out = "";
    for (_j = 0, _len1 = key.length; _j < _len1; _j++) {
      c = key[_j];
      if (_.isCapitalLetter(c)) {
        out += "-" + (c.toLowerCase());
      } else {
        out += c;
      }
    }
    return out;
  };

  _styleFromObject = function(obj, options) {
    var indent, ix, k, kFancy, keys, newline, out, semi, _j, _len1;
    if (options == null) {
      options = {};
    }
    _.defaults(options, {
      inline: true,
      indent: false
    });
    options.semi = !options.inline;
    out = "";
    keys = _.keys(obj).sort();
    indent = options.indent ? '\t' : '';
    newline = options.inline ? '' : '\n';
    for (ix = _j = 0, _len1 = keys.length; _j < _len1; ix = ++_j) {
      kFancy = keys[ix];
      semi = options.semi || ix !== keys.length - 1 ? ";" : '';
      k = _styleKeyFromFancy(kFancy);
      out += "" + indent + k + ":" + obj[kFancy] + semi + newline;
    }
    return out;
  };

  _attributesFromObject = function(obj) {
    var k, out, space, v, _j, _len1, _ref1;
    if (!oj.isObject(obj)) {
      return obj;
    }
    out = '';
    space = '';
    _ref1 = _.keys(obj).sort();
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      k = _ref1[_j];
      if ((v = obj[k]) != null) {
        out += "" + space + k + "=\"" + v + "\"";
      }
      space = ' ';
    }
    return out;
  };

  _cssFromObject = function(cssMap, isDebug) {
    var css, indent, inline, newline, rules, selector, space, styles;
    if (isDebug == null) {
      isDebug = false;
    }
    newline = isDebug ? '\n' : '';
    space = isDebug ? ' ' : '';
    inline = !isDebug;
    indent = isDebug;
    css = '';
    for (selector in cssMap) {
      styles = cssMap[selector];
      rules = _styleFromObject(styles, {
        inline: inline,
        indent: indent
      });
      css += "" + selector + space + "{" + newline + rules + "}" + newline;
    }
    return css;
  };

  _compileDeeper = function(method, ojml, options) {
    var i;
    i = options.indent;
    options.indent += '\t';
    method(ojml, options);
    return options.indent = i;
  };

  pass = function() {};

  _compileAny = function(ojml, options) {
    var _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8;
    switch (oj.typeOf(ojml)) {
      case 'array':
        _compileTag(ojml, options);
        break;
      case 'jquery':
        if ((_ref1 = options.html) != null) {
          _ref1.push(ojml.html());
        }
        if ((_ref2 = options.dom) != null) {
          _ref2.concat(ojml.get());
        }
        break;
      case 'string':
        if ((_ref3 = options.html) != null) {
          _ref3.push(ojml);
        }
        if ((_ref4 = options.dom) != null) {
          _ref4.appendChild(document.createTextNode(ojml));
        }
        break;
      case 'boolean':
      case 'number':
        if ((_ref5 = options.html) != null) {
          _ref5.push("" + ojml);
        }
        if ((_ref6 = options.dom) != null) {
          _ref6.appendChild(document.createTextNode("" + ojml));
        }
        break;
      case 'function':
        _compileAny(oj(ojml), options);
        break;
      case 'null':
        break;
      case 'undefined':
        break;
      case 'object':
        break;
      default:
        if (oj.isOJ(ojml)) {
          if ((_ref7 = options.html) != null) {
            _ref7.push(ojml.el.outerHTML);
          }
          if ((_ref8 = options.dom) != null) {
            _ref8.appendChild(ojml.el);
          }
        }
    }
  };

  jqueryEvents = {
    bind: 1,
    on: 1,
    off: 1,
    live: 1,
    blur: 1,
    change: 1,
    click: 1,
    dblclick: 1,
    focus: 1,
    focusin: 1,
    focusout: 1,
    hover: 1,
    keydown: 1,
    keypress: 1,
    keyup: 1,
    mousedown: 1,
    mouseenter: 1,
    mousemove: 1,
    mouseout: 1,
    mouseup: 1,
    ready: 1,
    resize: 1,
    scroll: 1,
    select: 1
  };

  _compileTag = function(ojml, options) {
    var attr, attrName, attrValue, attributes, child, children, ek, el, ev, events, selector, space, styles, tag, tagType, _base, _j, _k, _len1, _len2, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6;
    tag = ojml[0];
    tagType = typeof tag;
    tag = (tagType === 'function' || tagType === 'object') && (tag.type != null) ? tag.type : tag;
    if (!(oj.isString(tag) && tag.length > 0)) {
      throw new Error('oj.compile: tag is missing in array');
    }
    if (_.isCapitalLetter(tag[0])) {
      return _compileDeeper(_compileAny, new oj[tag](ojml.slice(1)), options);
    }
    options.tags[tag] = true;
    attributes = null;
    if (oj.isObject(ojml[1])) {
      attributes = ojml[1];
    }
    children = attributes ? ojml.slice(2) : ojml.slice(1);
    if (options.css && tag === 'css') {
      for (selector in attributes) {
        styles = attributes[selector];
        if ((_ref1 = (_base = options.css)[selector]) == null) {
          _base[selector] = styles;
        }
        _.extend(options.css[selector], styles);
      }
    }
    if (!options.ignore[tag]) {
      _attributeCMeansClass(attributes);
      _attributeStyleAllowsObject(attributes);
      _attributeClassAllowsArrays(attributes);
      events = _attributesFilterOutEvents(attributes);
      if (options.dom && (typeof document !== "undefined" && document !== null)) {
        el = document.createElement(tag);
        if (oj.isDOMElement(options.dom)) {
          options.dom.appendChild(el);
        }
        options.dom = el;
        if (oj.isObject(attributes)) {
          _ref2 = _.keys(attributes).sort();
          for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
            attrName = _ref2[_j];
            attrValue = attributes[attrName];
            el.setAttribute(attrName, attrValue);
          }
        }
        for (ek in events) {
          ev = events[ek];
          if (typeof $ !== "undefined" && $ !== null) {
            if (oj.isArray(ev)) {
              $(el)[ek].apply(this, ev);
            } else {
              $(el)[ek](ev);
            }
          } else {
            console.error("oj: jquery is missing when binding a '" + ek + "' event");
          }
        }
      }
      if (options.html) {
        attr = (_ref3 = _attributesFromObject(attributes)) != null ? _ref3 : '';
        space = attr === '' ? '' : ' ';
        options.html.push("<" + tag + space + attr + ">");
      }
    }
    for (_k = 0, _len2 = children.length; _k < _len2; _k++) {
      child = children[_k];
      if (options.debug && children.length > 1) {
        if ((_ref4 = options.html) != null) {
          _ref4.push("\n\t" + options.indent);
        }
      }
      _compileDeeper(_compileAny, child, options);
    }
    if (options.debug && children.length > 1) {
      if ((_ref5 = options.html) != null) {
        _ref5.push("\n" + options.indent);
      }
    }
    if (!options.ignore[tag]) {
      if (options.html && (children.length > 0 || oj.tag.isClosed(tag))) {
        if ((_ref6 = options.html) != null) {
          _ref6.push("</" + tag + ">");
        }
      }
      if (options.dom) {
        options.dom = options.dom.parentNode;
      }
    }
  };

  _attributeStyleAllowsObject = function(attr) {
    if (oj.isObject(attr != null ? attr.style : void 0)) {
      attr.style = _styleFromObject(attr.style, {
        inline: true
      });
    }
  };

  _attributeCMeansClass = function(attr) {
    if ((attr != null ? attr.c : void 0) != null) {
      attr["class"] = attr.c;
      delete attr.c;
    }
  };

  _attributeClassAllowsArrays = function(attr) {
    if (oj.isArray(attr != null ? attr["class"] : void 0)) {
      attr["class"] = attr.join(' ');
    }
  };

  _attributesFilterOutEvents = function(attr) {
    var k, out, v;
    out = {};
    if (attr) {
      for (k in attr) {
        v = attr[k];
        if (jqueryEvents[k] != null) {
          out[k] = v;
          delete attr[k];
        }
      }
    }
    return out;
  };

  oj.toDOM = function(options, ojml) {
    var result;
    if (!oj.isObject(options)) {
      ojml = options;
      options = {};
    }
    _.extend(options, {
      dom: true,
      html: true,
      css: true
    });
    result = oj.compile(options, ojml);
    if (typeof result.js === "function") {
      result.js();
    }
    return result.dom;
  };

  oj.toHTML = function(options, ojml) {
    if (!oj.isObject(options)) {
      ojml = options;
      options = {};
    }
    _.extend(options, {
      dom: false,
      js: false,
      html: true,
      css: false
    });
    return (oj.compile(options, ojml)).html;
  };

  oj.toCSS = function(options, ojml) {
    if (!oj.isObject(options)) {
      ojml = options;
      options = {};
    }
    _.extend(options, {
      dom: false,
      js: false,
      html: false,
      css: true
    });
    return (oj.compile(options, ojml)).css;
  };

  _.inherit = function(child, parent) {
    var ctor, key;
    for (key in parent) {
      oj.copyProperty(child, parent, key);
    }
    ctor = function() {};
    ctor.prototype = parent.prototype;
    child.prototype = new ctor();
    child.prototype["super"] = parent.prototype;
  };

  oj.type = function(name, args) {
    var Out, delay, methodKeys, methods, propKeys, properties, typeProps, _ref1, _ref2, _ref3;
    if (args == null) {
      args = {};
    }
    if (!oj.isString(name)) {
      throw 'oj.type: string expected for first argument';
    }
    if (!oj.isObject(args)) {
      throw 'oj.type: object expected for second argument';
    }
    if ((_ref1 = args.methods) == null) {
      args.methods = {};
    }
    if ((_ref2 = args.properties) == null) {
      args.properties = {};
    }
    if ((_ref3 = args.constructor) == null) {
      args.constructor = function() {};
    }
    delay = '__DELAYED__';
    Out = new Function("return function " + name + "(){\n  var _this = this;\n  if ( !(this instanceof " + name + ") )\n    _this = new " + name + "('" + delay + "');\n\n  if (arguments && arguments[0] != '" + delay + "')\n    " + name + ".prototype.constructor.apply(_this, arguments);\n\n  return _this;\n}")();
    if (args.inherits != null) {
      _.inherit(Out, args.inherits);
    }
    oj.addMethod(Out.prototype, 'constructor', function() {
      if (args.inherits != null) {
        args.inherits.prototype.constructor.apply(this, arguments);
      }
      try {
        args.constructor.apply(this, arguments);
      } catch (e) {
        throw e;
      }
      return this;
    });
    typeProps = {
      type: {
        value: name,
        writable: false,
        enumerable: false
      },
      isOJ: {
        value: true,
        writable: false,
        enumerable: false
      }
    };
    oj.addProperties(Out, typeProps);
    oj.addProperties(Out.prototype, typeProps);
    propKeys = (_.keys(args.properties)).sort();
    if (Out.prototype.properties != null) {
      propKeys = _.uniqueSortedUnion(Out.prototype.properties, propKeys);
    }
    properties = {
      value: propKeys,
      writable: false,
      enumerable: false
    };
    oj.addProperty(Out, 'properties', properties);
    oj.addProperty(Out.prototype, 'properties', properties);
    methodKeys = (_.keys(args.methods)).sort();
    if (Out.prototype.methods != null) {
      methodKeys = _.uniqueSortedUnion(Out.prototype.methods, methodKeys);
    }
    methods = {
      value: methodKeys,
      writable: false,
      enumerable: false
    };
    oj.addProperty(Out, 'methods', methods);
    oj.addProperty(Out.prototype, 'methods', methods);
    _.extend(args.methods, {
      set: function(k, v) {
        var key, obj, value;
        obj = k;
        if (!oj.isObject(k)) {
          obj = {};
          obj[k] = v;
        }
        for (key in obj) {
          value = obj[key];
          this[key] = value;
        }
      },
      toJSON: function() {
        var json, prop, _j, _len1, _ref4;
        json = {};
        _ref4 = this.properties;
        for (_j = 0, _len1 = _ref4.length; _j < _len1; _j++) {
          prop = _ref4[_j];
          json[prop] = this[prop];
        }
        return json;
      }
    });
    oj.addMethods(Out.prototype, args.methods);
    oj.addProperties(Out.prototype, args.properties);
    return Out;
  };

  _.optionsUnion = function(argList) {
    var list, obj, v, _j, _len1;
    obj = {};
    list = [];
    for (_j = 0, _len1 = argList.length; _j < _len1; _j++) {
      v = argList[_j];
      if (oj.isObject(v)) {
        obj = _.extend(obj, v);
      } else {
        list.push(v);
      }
    }
    return {
      options: obj,
      args: list
    };
  };

  oj.View = oj.type('View', {
    constructor: function() {
      var args, options, optionsUnion, _ref1;
      optionsUnion = _.optionsUnion(arguments);
      options = optionsUnion.options, args = optionsUnion.args;
      if ((_ref1 = options.id) == null) {
        options.id = oj.id();
      }
      this._id = options.id;
      _.argumentsAppend(this);
      this.set(options);
      return optionsUnion;
    },
    properties: {
      el: {
        get: function() {
          var $dom, dom, ojml;
          if (oj.isDOMElement(this._el)) {
            return this._el;
          }
          if (typeof $ !== "undefined" && $ !== null) {
            this._el = $('#' + this._id).get(0);
            if (oj.isDOMElement(this._el)) {
              return this._el;
            }
          }
          _.argumentsPush();
          ojml = this.make();
          _.argumentsPop();
          dom = (oj.compile({
            dom: true,
            html: false,
            css: false
          }, ojml)).dom;
          $dom = $(dom);
          if (!$dom.attr('id')) {
            $dom.attr({
              id: oj.id()
            });
          }
          $dom.addClass(this.type);
          return this._el = dom;
        }
      },
      $el: {
        get: function() {
          return $(this.el);
        }
      },
      id: {
        get: function() {
          return this._id;
        }
      },
      attributes: {
        get: function() {
          return this.$el.attributes();
        },
        set: function() {
          var _ref1;
          return (_ref1 = this.$el).attributes.apply(_ref1, arguments);
        }
      },
      hidden: {
        get: function() {
          return $el.css('display') === 'none';
        },
        set: function(v) {
          if (v) {
            return $el.hide();
          } else {
            return $el.show();
          }
        }
      }
    },
    methods: {
      make: function() {
        return oj.div();
      },
      $: function() {
        return this.$el.find.apply(this, arguments);
      },
      toHTML: function(options) {
        console.log("---- CALLING toHTML");
        return this.el.outerHTML + (options.debug ? '\n' : '');
      },
      toDOM: function() {
        console.log("---- CALLING toDOM");
        return this.el;
      },
      toString: function() {
        console.log("---- CALLING toHTML");
        return this.toHTML();
      },
      detach: function() {
        throw 'detach nyi';
      },
      attach: function() {
        throw 'attach nyi';
      }
    }
  });

  oj.ModelView = oj.type('ModelView', {
    inherits: oj.View,
    properties: {
      model: {
        get: function() {
          return this._model;
        },
        set: function(v) {
          if (oj.isBackbone(this._model)) {
            this._model.off('change', this.modelChange);
          }
          this._model = v;
          if (oj.isBackbone(this._model)) {
            this._model.on('change', this.modelChange);
          }
        }
      }
    },
    methods: {
      modelChange: function() {},
      viewChange: function() {}
    }
  });

  oj.FormView = oj.type('FormView', {
    inherits: oj.ModelView,
    properties: {
      key: {
        get: function() {
          return this._key;
        },
        set: function(v) {
          this._key = v;
        }
      },
      value: {
        get: function() {
          throw 'value get needs override';
        },
        set: function(v) {
          throw 'value set needs override';
        }
      },
      change: {
        get: function() {
          return this._change;
        },
        set: function(v) {
          this._change = v;
        }
      },
      formValue: {
        get: function() {
          return this.$el.attr('value');
        },
        set: function(v) {
          this.$el.attr('value', v);
        }
      }
    },
    methods: {
      modelChange: function() {
        if ((this.model != null) && (this.key != null)) {
          return this.value = this.model[this.key];
        }
      },
      viewChange: function() {
        if ((this.model != null) && (this.key != null)) {
          this.model[this.key] = this.value;
        }
        return typeof this.change === "function" ? this.change(this) : void 0;
      }
    }
  });

  oj.TextBox = oj.type('TextBox', {
    inherits: oj.FormView,
    properties: {
      value: {
        get: function() {
          return this.el.value;
        },
        set: function(v) {
          this.el.value = v;
        }
      }
    },
    methods: {
      make: function(props) {
        var _this = this;
        return oj.input({
          type: 'text',
          change: function() {
            return _this.viewChange();
          }
        });
      }
    }
  });

  oj.CheckBox = oj.type('CheckBox', {
    inherits: oj.FormView,
    properties: {
      value: {
        get: function() {
          return this.el.checked;
        },
        set: function(v) {
          v = !!v;
          this.el.checked = v;
          if (v) {
            this.$el.attr('checked', 'checked');
          } else {
            this.$el.removeAttr('checked');
          }
        }
      }
    },
    methods: {
      make: function(props) {
        var _this = this;
        return oj.input({
          type: 'checkbox',
          change: function() {
            return _this.viewChange();
          }
        });
      }
    }
  });

  oj.TextArea = oj.type('TextArea', {
    inherits: oj.FormView,
    properties: {
      value: {
        get: function() {
          return this.el.value;
        },
        set: function(v) {
          this.el.value = v;
        }
      }
    },
    methods: {
      make: function(props) {
        var _this = this;
        return oj.textarea({
          change: function() {
            return _this.viewChange();
          }
        });
      }
    }
  });

}).call(this);
